<!DOCTYPE html>
<html>

<head>
  <title>RLO 어디서 뛰시나요?</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <style>
    #map {
      height: 100%;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    let map;

    function createMarker(location, title, iconUrl, address) {
      const marker = new google.maps.Marker({
        position: location,
        title: title,
        icon: iconUrl,
      });

      const infowindow = new google.maps.InfoWindow({
        content: `<strong>${title}</strong><br>${address}`
      });

      marker.addListener("click", () => {
        infowindow.open(map, marker);
      });

      return marker;
    }

    function geocodeAddress(geocoder, address, title, iconUrl) {
      return new Promise((resolve, reject) => {
        geocoder.geocode({
          address
        }, (results, status) => {
          if (status === 'OK') {
            const location = results[0].geometry.location;
            const marker = createMarker(location, title, iconUrl, address);
            resolve(marker);
          } else {
            console.warn(`주소 변환 실패: ${address} (${status})`);
            resolve(null);
          }
        });
      });
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: {
          lat: 37.6,
          lng: 126.9
        }
      });

      const geocoder = new google.maps.Geocoder();
      const oms = new OverlappingMarkerSpiderfier2(map, {
        keepSpiderfied: true
      });

      fetch('RLOMap250919.json')
        .then(response => response.json())
        .then(runDataList => {
          const geocodePromises = runDataList.map(data => {
            if (data.city) {
              return geocodeAddress(geocoder, data.city, data.title, data.icon);
            }
            return Promise.resolve(null);
          });

          Promise.all(geocodePromises).then(markers => {
            const validMarkers = markers.filter(marker => marker !== null);
            validMarkers.forEach(marker => {
              oms.addMarker(marker); // OMS에 마커 등록
            });
            if (validMarkers.length > 0) {
              new markerClusterer.MarkerClusterer({
                markers: validMarkers,
                map
              });
            }
          });
        })
        .catch(error => {
          console.error("데이터 로딩 실패:", error);
        });
    }

    google.maps.event.addDomListener(window, 'load', initMap);
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGyPEBxM98Jhqx5bfF7N07W08jsOpzPmU&libraries=places">
  </script>
  <script src="https://cdn.jsdelivr.net/gh/fritz-c/OverlappingMarkerSpiderfier@1.1.4/dist/oms.min.js"></script>
  <script src='https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js'></script>
  </script>
</body>

</html>